{% extends "base.html" %}

{% block title %}{{ 'Edit' if mode == 'edit' else 'Create' }} Sales Report Request{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0 fw-bold">
                    {{ 'Edit' if mode == 'edit' else 'Create' }} Sales Report Request
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="salesReportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="period" class="form-label">Period *</label>
                                <select class="form-select" id="period" name="period" required>
                                    {% for period in periods %}
                                    <option value="{{ period.value }}" 
                                            {% if form_data.period == period.value %}selected{% endif %}>
                                        {{ period.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="grouping" class="form-label">Grouping</label>
                                <select class="form-select" id="grouping" name="grouping" onchange="toggleGroupingValue()">
                                    <option value="" {% if not form_data.grouping %}selected{% endif %}>Total Sales</option>
                                    {% for grouping in groupings %}
                                    <option value="{{ grouping.value }}" 
                                            {% if form_data.grouping == grouping.value %}selected{% endif %}>
                                        {{ grouping.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="currency" class="form-label">Currency *</label>
                                <select class="form-select" id="currency" name="currency" required>
                                    {% for currency in currencies %}
                                    <option value="{{ currency.value }}" 
                                            {% if form_data.currency == currency.value %}selected{% endif %}>
                                        {{ currency.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="grouping_value" class="form-label" id="groupingValueLabel">
                                    Grouping Value
                                </label>
                                <input type="text" class="form-control" id="grouping_value" name="grouping_value" 
                                       value="{{ form_data.grouping_value }}"
                                       placeholder="Enter specific value (e.g., 'Spain', 'Electronics')">
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 fw-bold">
                            Recipients
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRecipient()">
                            <i class="fas fa-plus me-1"></i>
                            Add Recipient
                        </button>
                    </div>

                    <div id="recipients-container">
                        {% for recipient in form_data.recipients %}
                        <div class="recipient-row" data-recipient-index="{{ loop.index0 }}">
                            <div class="row align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label">Email {{ loop.index }}</label>
                                    <input type="email" class="form-control" name="recipient_emails" 
                                           value="{{ recipient.email }}" placeholder="Enter email address">
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Name {{ loop.index }}</label>
                                    <input type="text" class="form-control" name="recipient_names" 
                                           value="{{ recipient.name }}" placeholder="Enter recipient name">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                                            onclick="removeRecipient(this)">
                                        <i class="fas fa-trash mb-1 mt-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                {{ 'Update' if mode == 'edit' else 'Create' }} Request
                            </button>
                            <a href="/" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                Cancel
                            </a>
                        </div>
                        {% if mode == 'edit' %}
                        <button type="button" class="btn btn-outline-warning" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>
                            Reset Form
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let recipientCount = {{ form_data.recipients|length }};

function toggleGroupingValue() {
    const groupingSelect = document.getElementById('grouping');
    const groupingValueInput = document.getElementById('grouping_value');
    const groupingValueLabel = document.getElementById('groupingValueLabel');
    
    if (groupingSelect.value === '') {
        groupingValueInput.disabled = true;
        groupingValueInput.required = false;
        groupingValueLabel.textContent = 'Grouping Value';
    } else {
        groupingValueInput.disabled = false;
        groupingValueInput.required = true;
        groupingValueLabel.textContent = 'Grouping Value *';
    }
}

function addRecipient() {
    recipientCount++;
    const container = document.getElementById('recipients-container');
    
    const recipientDiv = document.createElement('div');
    recipientDiv.className = 'recipient-row';
    recipientDiv.setAttribute('data-recipient-index', recipientCount - 1);
    
    recipientDiv.innerHTML = `
        <div class="row align-items-end">
            <div class="col-md-5">
                <label class="form-label">Email ${recipientCount}</label>
                <input type="email" class="form-control" name="recipient_emails" 
                       placeholder="Enter email address">
            </div>
            <div class="col-md-5">
                <label class="form-label">Name ${recipientCount}</label>
                <input type="text" class="form-control" name="recipient_names" 
                       placeholder="Enter recipient name">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                        onclick="removeRecipient(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(recipientDiv);
    updateRecipientLabels();
}

function removeRecipient(button) {
    const recipientDiv = button.closest('.recipient-row');
    recipientDiv.remove();
    updateRecipientLabels();
}

function updateRecipientLabels() {
    const recipients = document.querySelectorAll('.recipient-row');
    recipients.forEach((recipient, index) => {
        const emailLabel = recipient.querySelector('label:first-of-type');
        const nameLabel = recipient.querySelector('label:last-of-type');
        emailLabel.textContent = `Email ${index + 1}`;
        nameLabel.textContent = `Name ${index + 1}`;
    });
}

function resetForm() {
    if (confirm('Are you sure you want to reset the form? All changes will be lost.')) {
        window.location.reload();
    }
}

// Initialize grouping value state on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleGroupingValue();
});
</script>
{% endblock %}
